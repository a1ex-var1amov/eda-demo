- name: Respond to Sensitive File Read
  hosts: localhost
  tasks:

    - name: Display full event data (for debugging)
      debug:
        var: ansible_eda

    - name: Notify Security Team
      debug:
        msg: "ALERT: Sensitive file read detected on {{ ansible_eda.event.payload['hostname'] }}. Investigate immediately."

    - name: Capture pod details for investigation
      set_fact:
        pod_name: "{{ ansible_eda.event.payload['k8s.pod.name'] | default('N/A') }}"
        ns_name: "{{ ansible_eda.event.payload['k8s.ns.name'] | default('N/A') }}"

    - name: Display captured details
      debug:
        msg: "Pod: {{ pod_name }}, Namespace: {{ ns_name }}"

    - name: Perform Investigation
      command: >
        kubectl get pod {{ pod_name }} -n {{ ns_name }} -o json
      when: pod_name != 'N/A' and ns_name != 'N/A'

    - name: Alert in case of missing details
      fail:
        msg: "Failed to retrieve pod details. Ensure Falco data includes pod and namespace information."
      when: pod_name == 'N/A' or ns_name == 'N/A'
