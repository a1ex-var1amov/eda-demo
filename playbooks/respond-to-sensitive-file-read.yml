---
- name: Respond to Sensitive File Read
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Show All Available Variables (For Debugging)
      ansible.builtin.debug:
        var: vars

    - name: Display full event data (for debugging)
      ansible.builtin.debug:
        var: eda_event

    - name: Notify Security Team
      ansible.builtin.debug:
        msg: "ALERT: Sensitive file read detected on {{ inventory_hostname }}. Investigate immediately."

    - name: Capture pod details for investigation
      command: >
        kubectl describe pod {{ eda_event.payload['output_fields']['k8s.pod.name'] }}
        -n {{ eda_event.payload['output_fields']['k8s.ns.name'] }}
      register: pod_info

    - name: Display pod details
      ansible.builtin.debug:
        var: pod_info.stdout

    - name: Isolate the suspicious pod (optional)
      command: kubectl cordon {{ eda_event.payload['output_fields']['k8s.node.name'] | default('unknown node') }}

    - name: Send notification via webhook (optional)
      uri:
        url: "http://security-alerts.example.com/notify"
        method: POST
        body_format: json
        body:
          alert_type: "Sensitive File Read"
          node: "{{ eda_event.payload['output_fields']['k8s.node.name'] | default('unknown node') }}"
          pod: "{{ eda_event.payload['output_fields']['k8s.pod.name'] }}"
          namespace: "{{ eda_event.payload['output_fields']['k8s.ns.name'] }}"

